<%
  /*
Things passed into this page:
* schedule: all possible races
* displays: menu items for each race
* state: which state this is
  */
%>
<!doctype html>
<html lang="en-US">
  <head>
    <%= t.include("partials/_head.html", grunt.data.json) %>
    <link rel="stylesheet" type="text/css" href="state.css">
  </head>
  <body class="standalone">
    <script>
      var here = new URL(window.location);
      document.body.classList.add(here.searchParams.get("theme"));
      if (here.searchParams.has("embedded")) {
        document.body.classList.add("embedded")
        document.body.classList.remove("standalone");
      }
    </script>

    <%= t.include("partials/_nav.html", { prefix: "../" }) %>

    <main>

      <header>
        <svg width="60" height="60" viewBox="0 0 10 10" preserveAspectRatio="none">
          <circle cx=5 cy=5 r=5 fill="#888" />
        </svg>
        <h2>2020 Primaries and Caucuses</h2>
        <h1><%= json.strings[state] %> Results</h1>
      </header>

      <%

var hashRace = function(race) {
  var search = new URLSearchParams();
  var fields = "date office".split(" ");
  for (var f of fields) {
    if (f in race) {
      search.set(f, race[f]);
    }
  }
  return search.toString();
}
var makeOption = (item, suffix = "") => item.future ? `disabled` : `value="${hashRace(item.race)}${suffix}"`;
var makeLink = (item, suffix = "") => item.future ? `disabled` : `href="#${hashRace(item.race)}${suffix}"`;

      %>
      <select class="mobile-calendar">
        <% displays.forEach(function(item) { %>
          <option <%= makeOption(item, "&party=Dem") %>><%= item.office %> - Dem. (<%= item.date %>)</option>
          <option <%= makeOption(item, "&party=GOP") %>><%= item.office %> - GOP (<%= item.date %>)</option>
        <% }) %>
      </select>

      <nav class="race-calendar">
        <ul>
          <% displays.forEach(function(item) { %>
          <li>
            <a class="office" <%= makeLink(item) %>><%= item.office || "Run-off" %></a>
            <span class="parties">
              <a <%= makeLink(item, "&party=Dem") %>>Dem.</a> 
              | 
              <a <%= makeLink(item, "&party=GOP") %>>GOP</a>
            </span>
            <span class="date"><%= item.date %></span>
          <% }) %>
        </ul>
      </nav>

      <p class="chatter">
        <%= grunt.data.json.chatter[state] %>
      </p>

      <h3 class="latest-results">Latest Results</h3>

      <hr>

      <%

      displays.forEach(function(row, i) { %>

        <div class="module <%= i ? "hidden" : "" %>"
          data-office="<%= row.race.office %>"
          data-date="<%= row.race.date %>"
          tabindex="-1"
        >
          <%= t.include(`statePartials/_${row.race.element ? "random" : row.race.office}.html`, row.race) %>
          <% if (row.race.office != "H") { %>
          <a class="show-counties" <%= makeLink(row, "&counties=true") %>>See county results</a>
          <% } %>
        </div>

        <% if (row.race.office != "H") { %>
        <div class="module hidden"
          data-office="<%= row.race.office %>"
          data-date="<%= row.race.date %>"
          data-counties="true"
          tabindex="-1"
        >
          <%= t.include("statePartials/_counties.html", row.race) %>
        </div>
        <% } %>

      <% }) %>

    </main>

    <script src="state.js" async></script>
    <%= t.include("partials/_analytics.html") %>
  </body>
</html>

